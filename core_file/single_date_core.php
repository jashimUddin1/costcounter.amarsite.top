<?php
// core_file/single_date_core.php

session_start();
include("../db/dbcon.php");

// ржЗржЙржЬрж╛рж░ рж▓ржЧржЗржи ржирж╛ ржХрж░рж▓рзЗ рж░рж┐ржбрж╛ржЗрж░рзЗржХрзНржЯ ржХрж░рзЛ
if (!isset($_SESSION['authenticated'])) {
    header("Location: ../login/index.php");
    exit();
}

$user_id = $_SESSION['auth_user']['id'] ?? null;

// ржлрж░рзНржо рж╕рж╛ржмржорж┐ржЯ ржЪрзЗржХ
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $date = $_POST['date'] ?? '';
    $bulk_description = $_POST['bulk_description'] ?? '';
    $redirect_query = $_POST['redirect_query'] ?? '';
    $created_at = date('Y-m-d H:i:s');

    // ржлрж┐рж▓рзНржб ржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи
    if (empty($date) || empty($bulk_description)) {
        $_SESSION['warning'] = "тЭМ ржЗржиржкрзБржЯ ржлрж╛ржБржХрж╛ рж░рж╛ржЦрж╛ ржпрж╛ржмрзЗ ржирж╛!";
        header("Location: ../index.php?$redirect_query");
        exit();
    }

    // рждрж╛рж░рж┐ржЦ ржерзЗржХрзЗ year, month, day_name ржмрзЗрж░ ржХрж░рзЛ
    $year = date('Y', strtotime($date));
    $month = date('F', strtotime($date));
    $day_name = date('l', strtotime($date)); // English day name

    // ЁЯФ╕ ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржХрж┐ржУрзЯрж╛рж░рзНржб ржорзНржпрж╛ржк
    $category_map = [
        'ржмрж╛ржЬрж╛рж░' => ['ржмрж╛ржЬрж╛рж░', 'ржЪрж╛рж▓', 'ржЖрж▓рзБ', 'ржбрж┐ржо', 'ржорж░рж┐ржЪ', 'ржЯржорзЗржЯрзЛ', 'рж░рзЗрж╣рж╛', 'ржорзБрж▓рж╛', 'ржкрзЗржБрзЯрж╛ржЬ', 'рж░рж╕рзБржи', 'рждрзЗрж▓', 'рждрж░ржХрж╛рж░рж┐'],

        'ржмрж╛рж╣рж┐рж░рзЗрж░ржЦрж░ржЪ' => ['ржЦрж╛ржмрж╛рж░', 'ржлрж▓', 'рж░рзБржЯрж┐'],
        'ржорзЛржмрж╛ржЗрж▓ржЦрж░ржЪ' => ['рж░рж┐ржЪрж╛рж░рзНржЬ', 'ржлрзНрж▓рзЗржХрзНрж╕рж┐рж▓рзЛржб', 'ржЯржкржЖржк'],
        'ржЧрж╛ржбрж╝рж┐ржнрж╛ржбрж╝рж╛' => ['ржЧрж╛ржбрж╝рж┐ ржнрж╛ржбрж╝рж╛', 'ржмрж╛рж╕ ржнрж╛ржбрж╝рж╛', 'рж░рж┐ржХрзНрж╕рж╛ ржнрж╛ржбрж╝рж╛'],
        'ржмрж╛рж╕рж╛ржнрж╛ржбрж╝рж╛' => ['ржнрж╛ржбрж╝рж╛', 'ржмрж╛ржбрж╝рж┐ржнрж╛ржбрж╝рж╛', 'рж╣рж╛ржЙрж╕ рж░рзЗржирзНржЯ'],

        'ржмрж┐рж▓' => ['ржмрж┐ржжрзНржпрзБрзО', 'ржЗржирзНржЯрж╛рж░ржирзЗржЯ', 'ржЧрзНржпрж╛рж╕', 'ржкрж╛ржирж┐'],
        'ржЧрзГрж╣рж╕рзНржерж╛рж▓рзАржЬрж┐ржирж┐рж╕ржкрждрзНрж░' => ['ржЬрж┐ржирж┐рж╕', 'ржмрзЛрждрж▓', 'ржмрж╛рж▓рждрж┐', 'ржмрзНржпрж╛ржЧ'],
        'ржЧрзГрж╣рж╕рзНржерж╛рж▓рзАржорзЗрж░рж╛ржоржд' => ['ржЧрзГрж╣рж╕рзНржерж╛рж▓рзА ржорзЗрж░рж╛ржоржд'],
        'ржорж╛рж▓ржЬрж┐ржирж┐рж╕' => ['ржорж╛рж▓ ржЬрж┐ржирж┐рж╕', 'ржорж╛рж▓ржЬрж┐ржирж┐рж╕'],

        'ржХрж╕ржорзЗржЯрж┐ржХрзНрж╕' => ['ржХрж╕ржорзЗржЯрж┐ржХрзНрж╕'],
        'ржжрж╛ржУрзЯрж╛рждржЦрж░ржЪ' => ['ржжрж╛ржУрзЯрж╛ржд ржЦрж░ржЪ', 'ржжрж╛ржУрзЯрж╛рждржЦрж░ржЪ'],

        'ржЪрж┐ржХрж┐рзОрж╕рж╛' => ['ржФрж╖ржз', 'ржбрж╛ржХрзНрждрж╛рж░', 'рж╣рж╛рж╕ржкрж╛рждрж╛рж▓'],
        'ржХрзЗржирж╛ржХрж╛ржЯрж╛' => ['ржкрзЛрж╢рж╛ржХ', 'рж╢рж╛рж░рзНржЯ', 'ржкрзНржпрж╛ржирзНржЯ', 'ржЬрзБрждрж╛', 'ржХрж╛ржкрзЬ'],

        'ржмржЗржЦрж╛рждрж╛' => ['ржмржЗржЦрж╛рждрж╛', 'ржмржЗ ржЦрж╛рждрж╛'],
        'ржкрж░рж┐ржмрж╛рж░' => ['ржкрж░рж┐ржмрж╛рж░'],
        'рж╕рж╛ржЗржХрзЗрж▓ржорзЗрж░рж╛ржоржд' => ['рж╕рж╛ржЗржХрзЗрж▓ ржорзЗрж░рж╛ржоржд'],

        'ржкрзНрж░рж╛ржкрзНрждрж┐' => ['ржкрзНрж░рж╛ржкрзНрждрж┐'],
        'ржкрзНрж░ржжрж╛ржи' => ['ржкрзНрж░ржжрж╛ржи'],
        'ржЖржпрж╝' => ['ржЖржпрж╝'],

        'ржЕржирзНржпрж╛ржирзНржп' => ['ржЕржирзНржпрж╛ржирзНржп'],
    ];

    // ЁЯФ╕ ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржЦрзЛржБржЬрж╛рж░ ржлрж╛ржВрж╢ржи
    function detectCategory($description, $category_map)
    {
        foreach ($category_map as $category => $keywords) {
            foreach ($keywords as $keyword) {
                if (mb_strpos($description, $keyword) !== false) {
                    return $category;
                }
            }
        }
        return 'ржЕржирзНржпрж╛ржирзНржп';
    }

    // ЁЯФ╕ ржмрж┐ржмрж░ржг ржЧрзБрж▓рзЛ ржЖрж▓рж╛ржжрж╛ ржХрж░рзЛ
    $entries = explode(',', $bulk_description);
    $inserted = 0;

    foreach ($entries as $entry) {
        $entry = trim($entry);

        // ржзрж░рзЛ: "ржЦрж╛ржмрж╛рж░ рзлрзж" ржмрж╛ "ржлрж▓рзлрзйрзж"
        if (preg_match('/^(.+?)[\s]?(\d+(\.\d{1,2})?)$/u', $entry, $matches)) {
            $description = trim($matches[1]);
            $amount = floatval($matches[2]);
            $category = detectCategory($description, $category_map);
            

            $stmt = $con->prepare("INSERT INTO cost_data 
                (user_id, year, month, date, day_name, description, amount, category, created_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)");
            $stmt->bind_param(
                "iissssdss",
                $user_id,
                $year,
                $month,
                $date,
                $day_name,
                $description,
                $amount,
                $category,
                $created_at
            );

            if ($stmt->execute()) {
                $inserted++;
            }
        }
    }

    // тЬЕ ржлрж┐ржбржмрзНржпрж╛ржХ
    if ($inserted > 0) {
        $_SESSION['success'] = "тЬЕ {$inserted}ржЯрж┐ ржЦрж░ржЪ рж╕ржлрж▓ржнрж╛ржмрзЗ ржпрзЛржЧ рж╣рзЯрзЗржЫрзЗ!";
    } else {
        $_SESSION['danger'] = "тЭМ ржХрзЛржирзЛ ржЦрж░ржЪ ржпрзЛржЧ рж╣рзЯржирж┐! ржлрж░ржорзНржпрж╛ржЯ ржЪрзЗржХ ржХрж░рзБржи!";
    }

    header("Location: ../index.php?$redirect_query");
    exit();
} else {
    // рж╕рж░рж╛рж╕рж░рж┐ ржкрзЗржЗржЬрзЗ ржПрж▓рзЗ
    header("Location: ../index.php");
    exit();
}
