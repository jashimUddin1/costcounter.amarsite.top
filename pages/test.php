<?php // pages/test.php
session_start();
include("../db/dbcon.php");

// ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ö‡ßá‡¶ï
if (!isset($_SESSION['authenticated'])) {
  header("location: login/index.php");
  exit();
}

$user_id = $_SESSION['auth_user']['id'];
$query_string = $_SERVER['QUERY_STRING'];

// --- ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶õ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶Æ‡¶æ‡¶∏ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ ---
if (!isset($_GET['year']) || !isset($_GET['month'])) {
  // database ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
  $latest_sql = "SELECT DATE_FORMAT(date, '%Y') AS y, DATE_FORMAT(date, '%m') AS m
                 FROM cost_data
                 WHERE user_id = '$user_id'
                 ORDER BY date DESC
                 LIMIT 1";
  $latest_res = mysqli_query($con, $latest_sql);

  if ($latest_res && mysqli_num_rows($latest_res) > 0) {
    $latest = mysqli_fetch_assoc($latest_res);
    $current_year = $latest['y'];
    $current_month = $latest['m'];
  } else {
    // fallback ‚Üí ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã data ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
    $current_year = date('Y');
    $current_month = date('m');
  }
} else {
  $current_year = intval($_GET['year']);
  $month_input = trim($_GET['month']); // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá July ‡¶Ü‡¶∏‡¶¨‡ßá

  // ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‚Üí ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ mapping
  $month_map = [
    "January" => "01", "February" => "02", "March" => "03",
    "April" => "04", "May" => "05", "June" => "06",
    "July" => "07", "August" => "08", "September" => "09",
    "October" => "10", "November" => "11", "December" => "12"
  ];

  // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞ capitalize ‡¶ï‡¶∞‡ßá ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨
  $month_input = ucfirst(strtolower($month_input));

  if (isset($month_map[$month_input])) {
    $current_month = $month_map[$month_input];
  } else {
    // fallback ‚Üí ‡¶Ø‡¶¶‡¶ø ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü
    $current_month = str_pad($month_input, 2, '0', STR_PAD_LEFT);
  }
}


// --- English ‡¶•‡ßá‡¶ï‡ßá Bangla ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞ ---
function eng_to_bn($str)
{
  $eng = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
  $bn = ['‡ß¶', '‡ßß', '‡ß®', '‡ß©', '‡ß™', '‡ß´', '‡ß¨', '‡ß≠', '‡ßÆ', '‡ßØ'];
  return str_replace($eng, $bn, $str);
}

// --- ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡ßü ‡¶™‡ßÅ‡¶∞‡ßã ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ---
function bn_full_date($date)
{
  $months = [
    "January" => "‡¶ú‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø", "February" => "‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø", "March" => "‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö",
    "April" => "‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤", "May" => "‡¶Æ‡ßá", "June" => "‡¶ú‡ßÅ‡¶®",
    "July" => "‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á", "August" => "‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü", "September" => "‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞",
    "October" => "‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞", "November" => "‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "December" => "‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞"
  ];
  $days = [
    "Saturday" => "‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞", "Sunday" => "‡¶∞‡¶¨‡¶ø‡¶¨‡¶æ‡¶∞", "Monday" => "‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞",
    "Tuesday" => "‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤‡¶¨‡¶æ‡¶∞", "Wednesday" => "‡¶¨‡ßÅ‡¶ß‡¶¨‡¶æ‡¶∞", "Thursday" => "‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞",
    "Friday" => "‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞"
  ];

  $eng_date = date("j F Y, l", strtotime($date));
  $eng_to_bn = ['0','1','2','3','4','5','6','7','8','9'];
  $bn_digits = ['‡ß¶','‡ßß','‡ß®','‡ß©','‡ß™','‡ß´','‡ß¨','‡ß≠','‡ßÆ','‡ßØ'];
  $eng_date = str_replace(array_keys($months), array_values($months), $eng_date);
  $eng_date = str_replace(array_keys($days), array_values($days), $eng_date);
  $eng_date = str_replace($eng_to_bn, $bn_digits, $eng_date);

  return $eng_date;
}

// --- ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá Balance (balance_bd) ---
$query = "SELECT id, amount 
          FROM balancesheet 
          WHERE user_id = '$user_id' 
          AND DATE_FORMAT(date, '%Y-%m') = '$current_year-$current_month'
          AND balance_type = 'balance_bd'
          ORDER BY date ASC 
          LIMIT 1";

$result = mysqli_query($con, $query);

if ($result && mysqli_num_rows($result) > 0) {
  $row = mysqli_fetch_assoc($result);
  $balance_id = $row['id'];
  $current_balance = $row['amount']; // running balance ‡¶∂‡ßÅ‡¶∞‡ßÅ
  $has_balance_bd = true;
} else {
  $current_balance = 0;
  $has_balance_bd = false;
}

// --- ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶∏‡¶¨ cost_data ‡¶•‡ßá‡¶ï‡ßá ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡¶ø‡ßü‡ßá ‡¶Ü‡¶∏‡¶æ ---
$txn_query = "SELECT id, date, description, amount, category 
              FROM cost_data 
              WHERE user_id = '$user_id' 
              AND DATE_FORMAT(date, '%Y-%m') = '$current_year-$current_month'
              ORDER BY date ASC";

$txn_result = mysqli_query($con, $txn_query);

$grouped_data = [];
$total_monthly_cost = 0;
$total_monthly_income = 0;

if ($txn_result && mysqli_num_rows($txn_result) > 0) {
  while ($txn = mysqli_fetch_assoc($txn_result)) {
    $date = date('Y-m-d', strtotime($txn['date']));

    // --- Balance Update ---
    if ($txn['category'] === '‡¶Ü‡¶Ø‡¶º' || $txn['category'] === '‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶ø') {
      $current_balance += $txn['amount']; 
      $total_monthly_income += $txn['amount']; 
    } else {
      $current_balance -= $txn['amount']; 
      $total_monthly_cost += $txn['amount']; 
    }

    // --- running balance ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ---
    $txn['running_balance'] = $current_balance;

    // --- ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶®‡ßá‡¶∞ group ‡¶¨‡¶æ‡¶®‡¶æ‡¶®‡ßã ---
    $grouped_data[$date][] = $txn;
  }
}
?>

<!-- üëá ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö -->
<div class="costDetails">
  <div class="d-flex justify-content-between align-items-center mb-3 mt-3 monthly-cost-header">
    <h4 class="mb-0">üóìÔ∏è ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö</h4>

    <form method="GET" class="d-inline-block ms-3">
      <input type="hidden" name="year" value="<?= $current_year ?>">
      <input type="hidden" name="month" value="<?= $current_month ?>">
      <select name="sort" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit()">
        <option value="asc" <?= ($_GET['sort'] ?? '') === 'asc' ? 'selected' : '' ?>>‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶Ü‡¶ó‡ßá</option>
        <option value="desc" <?= ($_GET['sort'] ?? '') === 'desc' ? 'selected' : '' ?>>‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶ó‡ßá</option>
      </select>
    </form>

    <div class="d-flex">
      <h4 class="mb-0">‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü <span id="balanceAmount"><?= eng_to_bn($current_balance) ?></span> ‡¶ü‡¶æ‡¶ï‡¶æ </h4>
    </div>
  </div>

  <?php foreach ($grouped_data as $date => $records): ?>
    <div class="card mb-3">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <div>
          <strong><?= bn_full_date($date) ?></strong>
        </div>
      </div>

      <div class="card-body">
        <?php $total = 0; $i = 1; echo '<ul class="list-group list-group-flush">'; ?>
        <?php foreach ($records as $txn): ?>
          <?php if ($txn['category'] !== '‡¶Ü‡¶Ø‡¶º' && $txn['category'] !== '‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶ø') {
            $total += $txn['amount'];
          } ?>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <?= eng_to_bn($i) ?>. <?= eng_to_bn($txn['description']) ?>  
              <?= eng_to_bn($txn['amount']) ?> ‡¶ü‡¶æ‡¶ï‡¶æ (<?= $txn['category'] ?>)  
              üëâ <strong><?= eng_to_bn($txn['running_balance']) ?>‡ß≥</strong>
            </div>
          </li>
          <?php $i++; endforeach; ?>
        </ul>
        <div class="mt-2 fw-bold">üî∏ ‡¶Æ‡ßã‡¶ü: <?= eng_to_bn($total) ?> ‡¶ü‡¶æ‡¶ï‡¶æ</div>
      </div>
    </div>
  <?php endforeach; ?>

  <div class="mb-5 mt-5"><hr></div>

  <div class="container rounded-3 alert alert-success text-center fs-5 fixed-bottom mb-0">
    ‚úÖ ‡¶Æ‡ßã‡¶ü ‡¶Ü‡ßü: <strong><?= eng_to_bn($total_monthly_income) ?> ‡¶ü‡¶æ‡¶ï‡¶æ</strong> |
    ‚úÖ ‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡ßü: <strong><?= eng_to_bn($total_monthly_cost) ?> ‡¶ü‡¶æ‡¶ï‡¶æ</strong>
  </div>
</div>


<?php // --- ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶ï‡ßã‡¶° ---2nd 
// --- ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶õ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶Æ‡¶æ‡¶∏ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ ---
if (!isset($_GET['year']) || !isset($_GET['month'])) {
  $latest_sql = "SELECT DATE_FORMAT(date, '%Y') AS y, DATE_FORMAT(date, '%m') AS m
                 FROM cost_data
                 WHERE user_id = '$user_id'
                 ORDER BY date DESC
                 LIMIT 1";
  $latest_res = mysqli_query($con, $latest_sql);

  if ($latest_res && mysqli_num_rows($latest_res) > 0) {
    $latest = mysqli_fetch_assoc($latest_res);
    $current_year = $latest['y'];
    $current_month = $latest['m'];
  } else {
    $current_year = date('Y');
    $current_month = date('m');
  }
} else {
  $current_year = intval($_GET['year']);
  $month_input = trim($_GET['month']);

  $month_map = [
    "January" => "01", "February" => "02", "March" => "03",
    "April" => "04", "May" => "05", "June" => "06",
    "July" => "07", "August" => "08", "September" => "09",
    "October" => "10", "November" => "11", "December" => "12"
  ];

  $month_input = ucfirst(strtolower($month_input));
  if (isset($month_map[$month_input])) {
    $current_month = $month_map[$month_input];
  } else {
    $current_month = str_pad($month_input, 2, '0', STR_PAD_LEFT);
  }
}

// --- ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá Balance ---
$query = "SELECT id, amount 
          FROM balancesheet 
          WHERE user_id = '$user_id' 
          AND YEAR(date) = $current_year AND MONTH(date) = $current_month
          AND balance_type = 'balance_bd'
          ORDER BY date ASC 
          LIMIT 1";

$result = mysqli_query($con, $query);
if ($result && mysqli_num_rows($result) > 0) {
  $row = mysqli_fetch_assoc($result);
  $balance_id = $row['id'];
  $current_balance = $row['amount'];
  $has_balance_bd = true;
} else {
  $current_balance = 0;
  $has_balance_bd = false;
}

// --- Sort control ---
$sort = ($_GET['sort'] ?? 'asc') === 'desc' ? 'DESC' : 'ASC';

// --- ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ---
$txn_query = "SELECT id, date, description, amount, category 
              FROM cost_data 
              WHERE user_id = '$user_id' 
              AND YEAR(date) = $current_year AND MONTH(date) = $current_month
              ORDER BY date $sort";

$txn_result = mysqli_query($con, $txn_query);

$grouped_data = [];
$total_monthly_cost = 0;
$total_monthly_income = 0;

if ($txn_result && mysqli_num_rows($txn_result) > 0) {
  while ($txn = mysqli_fetch_assoc($txn_result)) {
    $date = date('Y-m-d', strtotime($txn['date']));

    if ($txn['category'] === '‡¶Ü‡¶Ø‡¶º' || $txn['category'] === '‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶ø') {
      $current_balance += $txn['amount'];
      $total_monthly_income += $txn['amount'];
    } else {
      $current_balance -= $txn['amount'];
      $total_monthly_cost += $txn['amount'];
    }

    $txn['running_balance'] = $current_balance;
    $grouped_data[$date][] = $txn;
  }
}
?>

<!-- ================= UI PART ================= -->
<div class="costDetails">
  <div class="d-flex justify-content-between align-items-center mb-3 mt-3 monthly-cost-header">
    <h4 class="mb-0">üóìÔ∏è ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö</h4>

    <form method="GET" class="d-inline-block ms-3">
      <input type="hidden" name="year" value="<?= $current_year ?>">
      <input type="hidden" name="month" value="<?= $current_month ?>">
      <select name="sort" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit()">
        <option value="asc" <?= ($_GET['sort'] ?? '') === 'asc' ? 'selected' : '' ?>>‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶Ü‡¶ó‡ßá</option>
        <option value="desc" <?= ($_GET['sort'] ?? '') === 'desc' ? 'selected' : '' ?>>‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶ó‡ßá</option>
      </select>
    </form>

    <div class="d-flex">
      <h4 class="mb-0">‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü <span id="balanceAmount"><?= eng_to_bn($current_balance) ?></span> ‡¶ü‡¶æ‡¶ï‡¶æ </h4>
    </div>
  </div>

  <?php foreach ($grouped_data as $date => $records): ?>
    <div class="card mb-3">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <div>
          <strong><?= bn_full_date($date) ?></strong>
        </div>

        <div class="rightEditDelete">
          <?php if (!empty($_SESSION['edit_date'])): ?>
            <button class="btn btn-sm btn-outline-secondary edit-date-btn" data-bs-toggle="modal"
              data-bs-target="#editDateModal" data-date="<?= date('Y-m-d', strtotime($date)) ?>">
              ‚úèÔ∏è ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ
            </button>
          <?php endif; ?>

          <?php if (!empty($_SESSION['delete_day'])): ?>
            <a href="core_file/delete_day_entries.php?date=<?= date('d-m-Y', strtotime($date)) ?>"
              class="btn btn-sm btn-outline-danger"
              onclick="return confirm('üî¥ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá, <?= bn_full_date($date) ?> ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')">
              üóëÔ∏è
            </a>
          <?php endif; ?>
        </div>
      </div>

      <div class="card-body">
        <?php $total = 0; $i = 1; echo '<ul class="list-group list-group-flush">'; ?>
        <?php foreach ($records as $txn): ?>
          <?php if ($txn['category'] !== '‡¶Ü‡¶Ø‡¶º' && $txn['category'] !== '‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶ø') {
            $total += $txn['amount'];
          } ?>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <?= eng_to_bn($i) ?>. <?= eng_to_bn($txn['description']) ?>  
              <?= eng_to_bn($txn['amount']) ?> ‡¶ü‡¶æ‡¶ï‡¶æ (<?= $txn['category'] ?>)
            </div>
            <div class="d-flex align-items-center gap-2">
         
              <span class="badge bg-primary rounded-pill"> <?= eng_to_bn($txn['running_balance']) ?> ‡ß≥</span> <!-- üí∞ -->

              <?php if (!empty($_SESSION['edit_enabled'])): ?>
                <button class="btn btn-sm btn-outline-warning edit-btn" 
                  data-id="<?= $txn['id'] ?>"
                  data-date="<?= date('Y-m-d', strtotime($txn['date'])) ?>"
                  data-description="<?= htmlspecialchars($txn['description']) ?>" 
                  data-amount="<?= $txn['amount'] ?>"
                  data-category="<?= htmlspecialchars($txn['category']) ?>" 
                  data-bs-toggle="modal"
                  data-bs-target="#editCostDataModal">
                  ‚úèÔ∏è
                </button>
              <?php endif; ?>

              <?php if (!empty($_SESSION['delete_enabled'])): ?>
                <a href="core_file/delete_entry.php?id=<?= $txn['id'] ?>" class="btn btn-sm btn-outline-danger"
                  onclick="return confirm('‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶ì?')">üóëÔ∏è</a>
              <?php endif; ?>
            </div>
          </li>
          <?php $i++; endforeach; ?>
        </ul>
        <div class="mt-2 fw-bold">üî∏ ‡¶Æ‡ßã‡¶ü: <?= eng_to_bn($total) ?> ‡¶ü‡¶æ‡¶ï‡¶æ</div>
      </div>
    </div>
  <?php endforeach; ?>

  <div class="mb-5 mt-5"><hr></div>

  <div class="container rounded-3 alert alert-success text-center fs-5 fixed-bottom mb-0">
    ‚úÖ ‡¶Æ‡ßã‡¶ü ‡¶Ü‡ßü: <strong><?= eng_to_bn($total_monthly_income) ?> ‡¶ü‡¶æ‡¶ï‡¶æ</strong> |
    ‚úÖ ‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡ßü: <strong><?= eng_to_bn($total_monthly_cost) ?> ‡¶ü‡¶æ‡¶ï‡¶æ</strong>
  </div>
</div>
